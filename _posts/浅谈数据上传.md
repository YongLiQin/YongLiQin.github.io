---
title: 浅谈数据上传
date: 2017-11-13 23:28:41
tags: NODEJS
---

## 序言

本编总结一下自己在数据上传上的知识总结。

<!--more-->

## 数据上传

### 判断是否有请求数据

nodejs中，如果请求中带有内容部分(如POST请求，它具有报头和内容)，内容部分需要用户自行接受和解析。通过报头的Transfer-Encoding或Content-Length即可判断请求中是否带有内容。

```js
let hasBody = req => 'transfer-encoding' in req.headers || 'content-length' in req.headers;
```

HTTP_Parser解析报头结束后，报文内容部分会通过data事件触发，我们只需以流的方式处理即可，如下所此:

```js
function (req, res) {
    if(hasBody(req)) {
        let buffers = [];
        req.on('data', chunk => {
            buffers.push(chunk);
        });
        req.on('end', () => {
            req.rawBody = Buffer.concat(buffers).toString();
            handle(req, res);
        });
    }
}
```

### 表单提交

#### POST

默认的POST表单提交，请求头中的Content-Type字段值为application/x-www-form-urlencoded如下所示:

```js
Content-Type: application/x-www-form-urlencoded
```

它的报文体内容跟查询字符串相同:

```js
foo=bar&baz=val
```

因此解析它很容易:

```js
let handle = (req, res) {
    if(req.headers['content-type'] === 'application/x-www-form-url') {
        req.body = querystring.parse(req.rawbody);
    }
    todo(req, res);
};
```

> get方式的表单提交，浏览器用x-www-form-urlencoded的编码方式把表单数据转换成一个字符串，然后添加到目标url地址后面。

### 其他格式

JSON类型=>application/json

XML=>application/xml

注意的是，在Content-Type中还可能附加如下所示的编码信息:

```js
Content-Type: application/json; charset=utf-8
```

所以在判断的时候，需要注意区分，如下所示

```js
let mime = req => {
    let str = req.headers['content-type'] || '';
    return str.split(';')[0];
}
```

解析JSON

```js
let handle = (req, res) => {
    if(mime(req) == 'application/json') {
        try {
            req.body = JSON.parse(req.rawBody);
        } catch (e) {
            res.writeHead(400);
            req.end('Invalid JSON');
            return;
        }
        todo(req, res);
    }
}
```

### ajax提交

POST提交默认的类型Content-Type是:

```http
Content-Type: text/plain;charset=UTF-8
```

通过.setRequestHeader(key, value)来设置请求头部信息。

比如设置提交类型为application/json

```js
xhr.setRequestHeader('Content-Type', 'application/json');
```
> GET是通过拼接url提交请求数据的，所以它的请求头中不具有Content-Type字段的东西。

### 附件上传

附件上传数据类型为Content-Type: multipart/form-data

通过指定表单属性enctype为multipart/form-data来设定表单提交的内容。

```html
<form enctype="multipart/form-data">
</form>
```

浏览器遇到multipart/form-data表单提交时，构造的请求报文与普通表单完全不同。首先它的报头中最为特殊的如下所示: 

```http
Content-Length:575
Content-Type:multipart/form-data; boundary=----WebKitFormBoundaryzMnpBNaj1z0QYAPt
```

![](/img/form-data.png)

它代表本次提交的内容是由多部分构成，其中boundary=...指定的是每部分的分界符，...是随机生成的一段字符串报文体内容将通过在它前面添加--进行分割，报文结束时在它前后都加上--表示结束。

解析

```js
(req, res) => {
    if(hasBody(req)) {
        let done = () => {
            handle(req, res);
        };
        if(mime(req) === 'application/json') {
            parseJSON(req, done);
        } else if(mime(req) == 'application/xml') {
            parseXML(req, res);
        } else if(mime(req) == 'multipart/form-data') {
            parseMultipart(req, done);
        } else {
            handle(req, res);
        }
    } 
}
```